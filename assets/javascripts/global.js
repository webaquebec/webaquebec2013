// Generated by CoffeeScript 1.6.3
/*
Author: Louis-Philippe Dumas, @louisdumas, github: lpdumas
*/


(function() {
  var OnePager, Schedule, Slider, html,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.App = {};

  html = document.documentElement;

  App.OPACITY = false;

  if (html.style.opacity !== void 0) {
    html.className += " opacity";
    App.OPACITY = true;
  } else {
    html.className += " no-opacity";
  }

  App.fbButton = '<div class="fb-like-template" data-href=" " data-send="false" data-layout="button_count" data-show-faces="false"></div>';

  App.twButton = '<a href="https://twitter.com/share" class="twitter-share-button-template" data-url=" ">Tweet</a>';

  /*
  # Class Slider {{{
  */


  Slider = (function() {
    function Slider(slider, opts) {
      var _this = this;
      this.slider = slider;
      this.slidesWrap = this.slider.find('.slides-wrap');
      this.navWrap = this.slider.find('.slider-nav');
      this.descWrap = this.slider.find('.descs');
      this.currentIndex = 0;
      this.isAnimated = false;
      this.timer = opts.timer != null ? opts.timer : 5000;
      this.slides = (function() {
        var key, slide, slideObject, slides, _i, _len, _ref;
        slides = [];
        _ref = _this.slidesWrap.find('.slide');
        for (key = _i = 0, _len = _ref.length; _i < _len; key = ++_i) {
          slide = _ref[key];
          slideObject = $(slide);
          slides.push(slideObject);
          if (key === _this.currentIndex) {
            _this.navWrap.append('<a href="javascript://" class="active" data-index="' + key + '"></a>');
            _this.descWrap.append('<span class="on-stage">' + slideObject.attr('data-desc') + '</span>');
          } else {
            _this.navWrap.append('<a href="javascript://" data-index="' + key + '"></a>');
            _this.descWrap.append('<span>' + slideObject.attr('data-desc') + '</span>');
          }
        }
        return slides;
      })();
      this.navElements = this.navWrap.find('a');
      this.descElements = this.descWrap.find('span');
      if (this.slides.length > 1) {
        this.slides[this.currentIndex].addClass('active');
        this.handleNav();
        if (this.timer > 0) {
          this.i = setInterval(function() {
            if (!_this.isAnimated) {
              _this.handleNextSlide();
              _this.isAnimated = true;
              return _this.slide();
            }
          }, this.timer);
        }
      }
    }

    Slider.prototype.handleNav = function() {
      var _this = this;
      return this.navElements.click(function(e) {
        var index, this_;
        this_ = $(e.target);
        index = parseInt(this_.attr('data-index'));
        if (_this.currentIndex !== index && !_this.isAnimated) {
          _this.nextSlideIndex = index;
          _this.isAnimated = true;
          return _this.slide();
        }
      });
    };

    Slider.prototype.handleNextSlide = function() {
      return this.nextSlideIndex = this.currentIndex === (this.slides.length - 1) ? 0 : this.currentIndex + 1;
    };

    Slider.prototype.slide = function() {
      var pos, t1, t2,
        _this = this;
      pos = this.slides[this.nextSlideIndex].position().left;
      this.descElements.removeClass('on-stage').addClass('backstage');
      this.descElements.eq(this.nextSlideIndex).addClass('backstage');
      t1 = setTimeout(function() {
        return _this.descElements.eq(_this.nextSlideIndex).removeClass('backstage').addClass('on-stage');
      }, 150);
      this.navElements.removeClass('active');
      this.navElements.eq(this.nextSlideIndex).addClass('active');
      this.slidesWrap.css({
        'left': -pos
      });
      return t2 = setTimeout(function() {
        _this.descElements.eq(_this.currentIndex).removeClass('backstage');
        _this.currentIndex = _this.nextSlideIndex;
        return _this.isAnimated = false;
      }, 500);
    };

    return Slider;

  })();

  /*
  # }}}
  */


  /*
  # Class Schedule {{{
  */


  Schedule = (function() {
    function Schedule(opts) {
      this.close = __bind(this.close, this);
      this.open = __bind(this.open, this);
      this.showConf = __bind(this.showConf, this);
      var onClose, onOpen, template,
        _this = this;
      this.slideWrapper = $('#schedule .slides-wrap');
      this.overFlowWrapper = $('#schedule .wrapper');
      this.navElement = $('#schedule-nav a');
      this.slides = this.slideWrapper.find('.slide');
      this.slideWrapperHeight = this.slideWrapper.outerHeight();
      this.currentSlide = this.slides.filter(".active");
      this.currentIndex = this.slides.index(this.currentSlide);
      this.openBtn = $('#schedule #open-shedule a');
      this.confLinks = $('#schedule a.white');
      this.confThumbParents = $('#schedule .conference');
      this.body = $('body');
      this.sideTimeLineSpan = $('#time-zone span');
      this.shareButtonWrap = $('.share-btn');
      this.startingHeight = 500;
      this.wrapConfContent = null;
      this.confScrollbar = null;
      this.loadingGIF = null;
      this.confIsOpen = false;
      template = '<section id="conf-desc">\n  <span class="loading"><img src="/assets/images/interface/loading.gif" /></span>\n  <div class="wrap-content"></div>\n</section>\n<span id="overlay"></span>';
      if (!$('#conf-desc').length) {
        this.body.append(template);
      }
      this.wrapConfContent = $('#conf-desc .wrap-content');
      this.loadingGIF = $('#conf-desc .loading');
      this.overlay = $('#overlay');
      this.confLinks.each(function() {
        var newHref, this_;
        this_ = $(this);
        newHref = this_.attr('href').replace('/horaire', '#/horaire');
        return this_.attr('href', newHref);
      });
      this.confLinks.click(function() {
        var this_;
        this_ = $(this);
        if (window.location.hash === this_.attr('href')) {
          return window.router.refresh();
        }
      });
      this.openBtn.click(function() {
        if (_this.openBtn.hasClass('active')) {
          return _this.close();
        } else {
          return _this.open();
        }
      });
      this.overlay.click(function() {
        return _this.closeConf();
      });
      onOpen = (opts != null) && (opts.onOpen != null) ? opts.onOpen : function() {};
      onClose = (opts != null) && (opts.onClose != null) ? opts.onClose : function() {};
      $(window).on('resize', function() {
        var newHeigh;
        if (_this.confScrollbar && _this.wrapConfContent) {
          newHeigh = _this.wrapConfContent.outerHeight() - (_this.wrapConfContent.find('figure').outerHeight() + 125) - 56;
          _this.wrapConfContent.find('.viewport').css({
            height: newHeigh
          });
          return _this.confScrollbar.tinyscrollbar_update();
        }
      });
      this.openBtn.hide();
      this.open();
      if (this.currentIndex !== 0) {
        this.slideTo(this.currentSlide.attr("id"));
      }
      $(this).bind('onOpen', onOpen);
      $(this).bind('onClose', onClose);
    }

    Schedule.prototype.showConf = function(id) {
      var link, request, url,
        _this = this;
      link = this.confLinks.filter('[data-id="' + id + '"]');
      url = link.attr('href').replace('#', '');
      this.confIsOpen = true;
      this.confThumbParent = link.closest('.conference');
      this.confThumbParents.removeClass('active');
      this.confThumbParent.addClass('active');
      if (!this.body.hasClass('lock')) {
        this.body.addClass('lock');
      }
      request = $.ajax({
        url: url.replace('.html', '.ajax.html'),
        type: "GET",
        dataType: "html"
      });
      request.done(function(response) {
        var newHeigh, t;
        _this.wrapConfContent.html(response);
        newHeigh = _this.wrapConfContent.outerHeight() - (_this.wrapConfContent.find('figure').outerHeight() + 125) - 56;
        _this.wrapConfContent.find('.viewport').css({
          height: newHeigh
        });
        _this.confScrollbar = $('#scrollbar1');
        _this.confScrollbar.tinyscrollbar();
        return t = setTimeout(function() {
          var t1;
          _this.loadingGIF.addClass('fadding');
          return t1 = setTimeout(function() {
            var fb, shareURL, tw;
            _this.loadingGIF.removeClass('fadding').addClass('off');
            shareURL = $('[data-shareURL]').attr('data-shareURL');
            fb = $(App.fbButton);
            tw = $(App.twButton);
            fb.addClass('fb-like').attr('data-href', shareURL);
            tw.addClass('twitter-share-button').attr('data-url', shareURL);
            _this.shareButtonWrap.html('').append(fb, tw);
            _this.shareButtonWrap.show();
            FB.XFBML.parse();
            return twttr.widgets.load();
          }, 200);
        }, 400);
      });
      return request.fail(function(response) {});
    };

    Schedule.prototype.closeConf = function() {
      var t,
        _this = this;
      this.confIsOpen = false;
      this.confThumbParents.removeClass('active');
      this.shareButtonWrap.hide();
      this.body.removeClass('lock');
      return t = setTimeout(function() {
        return _this.loadingGIF.removeClass('off');
      }, 400);
    };

    Schedule.prototype.slideTo = function(id) {
      var posX, target;
      target = this.slides.filter("#" + id);
      posX = target.position().left;
      this.navElement.removeClass('active');
      $('[data-ref="' + id + '"]').addClass('active');
      this.sideTimeLineSpan.removeClass('active');
      this.sideTimeLineSpan.filter("#" + id + "-lines").addClass('active');
      this.slideWrapper.css({
        'left': -posX
      });
      this.currentSlide = target;
      if (this.currentSlide.attr('id') !== 'mercredi') {
        return this.overFlowWrapper.css({
          'height': this.slideWrapperHeight,
          'overflow-y': 'hidden'
        });
      } else {
        return this.overFlowWrapper.css({
          'height': 800,
          'overflow-y': 'hidden'
        });
      }
    };

    Schedule.prototype.open = function() {
      $(this).trigger('onOpen');
      this.openBtn.html('Réduire');
      this.openBtn.addClass('active');
      if (this.currentSlide.attr('id') !== 'mercredi') {
        return this.overFlowWrapper.css({
          'height': this.slideWrapperHeight,
          'overflow-y': 'hidden'
        });
      } else {
        return this.overFlowWrapper.css({
          'height': 800,
          'overflow-y': 'hidden'
        });
      }
    };

    Schedule.prototype.close = function() {
      var t,
        _this = this;
      $(this).trigger('onClose');
      this.openBtn.html('Tout afficher');
      this.openBtn.removeClass('active');
      return t = setTimeout(function() {
        return _this.overFlowWrapper.css({
          'height': _this.startingHeight
        });
      }, 200);
    };

    return Schedule;

  })();

  /*
  # }}}
  */


  /*
  # Class OnePager {{{
  */


  OnePager = (function() {
    function OnePager() {
      this.hashHasChange = __bind(this.hashHasChange, this);
      var _this = this;
      this.didScroll = false;
      this.isAnimated = false;
      this.currentPage = 0;
      this.navWrap = $('nav[role="navigation"]');
      this.nav = this.navWrap.find('a');
      this.sectionsWrapp = $('#one-pager');
      this.sections = $('[data-section]');
      this.navHeight = this.navWrap.outerHeight();
      this.navOffset = this.navHeight;
      this.pagesOffset = {};
      this.resetSectionsOffset();
      this.animateWhenSliding = false;
      $(window).on('scroll', function() {
        return _this.didScroll = true;
      });
      this.nav.click(function() {
        if (window.location.hash === $(this).attr('href')) {
          return window.router.refresh();
        }
      });
      setInterval(function() {
        if (_this.didScroll) {
          _this.didScroll = false;
          return _this.HandleScrollEvents();
        }
      }, 20);
      this.stopScrollOnMouseScroll();
    }

    OnePager.prototype.stopScrollOnMouseScroll = function() {
      var stopScroll;
      stopScroll = function() {
        return $('body, html').stop();
      };
      if (window.addEventListener != null) {
        window.addEventListener('DOMMouseScroll', stopScroll, false);
        return window.addEventListener('mousewheel', stopScroll, false);
      }
    };

    OnePager.prototype.resetSectionsOffset = function() {
      var i,
        _this = this;
      i = 0;
      this.sections.length;
      return this.sections.each(function(index, element) {
        var pageEnd, pageId, pageStart, slideHeight, this_;
        this_ = $(element);
        if (i !== _this.sections.length - 1) {
          slideHeight = $(window).height() - $('#header').outerHeight();
        } else {
          slideHeight = $(window).height() - $('footer').outerHeight() - $('#header').outerHeight();
        }
        pageId = this_.attr('id');
        pageStart = this_.offset().top;
        pageEnd = this_.outerHeight() + this_.offset().top;
        _this.pagesOffset[i] = {
          'id': pageId,
          'offset': [pageStart, pageEnd]
        };
        return i++;
      });
    };

    OnePager.prototype.setActiveMenu = function(target) {
      this.nav.removeClass('active');
      return target.addClass('active');
    };

    OnePager.prototype.slideTo = function(target) {
      var moreOffsets, targetId, targetLink, targetScrollTop,
        _this = this;
      target = this.sections.filter(target);
      targetId = target.attr('id');
      moreOffsets = moreOffsets || 0;
      targetScrollTop = target.offset().top - this.navOffset - moreOffsets;
      targetLink = $("a[href='#/" + targetId + "/']");
      this.isAnimated = true;
      this.currentPage = this.getPageIndex(targetId);
      this.setActiveMenu(targetLink);
      targetScrollTop = targetScrollTop <= 0 ? 0 : targetScrollTop;
      if (this.animateWhenSliding) {
        return $('body, html').stop().animate({
          'scrollTop': targetScrollTop
        }, 650, $.bez([0.80, 0, 0.20, 1.0]), function() {
          return _this.isAnimated = false;
        });
      } else {
        return $('body, html').stop().animate({
          'scrollTop': targetScrollTop
        }, 0, function() {
          return _this.isAnimated = false;
        });
      }
    };

    OnePager.prototype.getPageIndex = function(id) {
      var i, object, _ref;
      _ref = this.pagesOffset;
      for (i in _ref) {
        object = _ref[i];
        if (object.id === id) {
          return parseInt(i);
        }
      }
    };

    OnePager.prototype.hashHasChange = function(target) {
      var newhash;
      newhash = "#" + target;
      return this.slideTo(newhash);
    };

    OnePager.prototype.HandleScrollEvents = function() {
      var pageId, precentIn, scroll, targetLink;
      if (!this.isAnimated) {
        scroll = $(window).scrollTop();
        scroll = scroll - this.pagesOffset[this.currentPage]['offset'][0];
        precentIn = scroll / (this.pagesOffset[this.currentPage]['offset'][1] - this.pagesOffset[this.currentPage]['offset'][0]);
        precentIn = Math.round(precentIn * 100);
        if (precentIn >= 80) {
          this.currentPage = this.currentPage + 1;
        } else if (precentIn < -20) {
          this.currentPage = this.currentPage - 1;
        }
        pageId = this.pagesOffset[this.currentPage]['id'];
        targetLink = $("a[href='#/" + pageId + "/']");
        if (!targetLink.hasClass('active')) {
          return this.setActiveMenu($("a[href='#/" + pageId + "/']"));
        }
      }
    };

    OnePager.prototype.currentPage = OnePager.currentPage;

    OnePager.prototype.isAnimated = OnePager.isAnimated;

    return OnePager;

  })();

  /*
  # }}}
  */


  $(function() {
    var $links, body, l, links, myGmap, myHomeSlider, myOnePager, mySchedule, stickyHeader;
    body = $('body');
    if (!window.console) {
      (function() {
        var f;
        f = function() {};
        return window.console = {
          log: f,
          info: f,
          dir: f,
          warn: f,
          error: f,
          trace: f,
          group: f,
          groupCollapsed: f,
          groupEnd: f,
          time: f,
          timeEnd: f,
          profile: f,
          profileEnd: f,
          count: f
        };
      })();
    }
    window.DOMAIN_REGEX = /[a-z0-9\-]+\.(com|org|ca|qc\.ca|gouv\.qc\.ca|net|info|biz|edu|gov|us|fr|dev.ixmedia.com|dev5.ixmedia.com|dev3.ixmedia.com)$/;
    $links = $('a');
    $links.keyup(function(e) {
      if (e.which === 9) {
        return $(this).addClass('focus');
      }
    });
    $links.blur(function() {
      return $(this).removeClass('focus');
    });
    window.domainWithoutSubdomain = function(domainWithSubdomain) {
      var matches;
      matches = domainWithSubdomain.match(DOMAIN_REGEX);
      if (matches) {
        return matches[0];
      } else {
        return null;
      }
    };
    links = $links.get();
    l = links.length;

  while (l--) {
    link = links[l];
    if (!link.className.match(/fancybox|videos/) && !link.href.match(/^(javascript:|mailto:)/) && (domainWithoutSubdomain(link.hostname) != domainWithoutSubdomain(location.hostname) || link.href.match(/\.(docx?|xlsx?|pptx?|pdf|eps|zip|vsd|vxd|rar|wma|mov|avi|wmv|mp3|mp4|mpg|mpeg|mpeg4|m4a|m4v|f4v|flv|csv|xml|ogg|oga|ogv|webm|jpg|jpeg|png|gif|webp|svg|ico|txt|css|js)$/))) {
      link.target = '_blank';
      link.title += link.title ? ' – S’ouvre dans une nouvelle fenêtre.' : 'S’ouvre dans une nouvelle fenêtre.';
      link.className += link.className.indexOf('externe') == -1 ? ' externe' : '';
    }
  }
  ;
    myHomeSlider = new Slider($('#slider'), {
      timer: 5000
    });
    myGmap = new CustomGmap('#gmap');
    mySchedule = new Schedule({
      onOpen: function() {
        return myOnePager.hashHasChange('horaire');
      },
      onClose: function() {
        return myOnePager.hashHasChange('horaire');
      }
    });
    myOnePager = new OnePager();
    $('#team [itemprop="name"]').each(function() {
      var $this, newRightPos;
      $this = $(this);
      newRightPos = $this.outerWidth() / 2;
      return $this.css({
        right: -newRightPos
      });
    });
    window.router = $.sammy(function() {
      this.get(/\#\/(accueil|horaire|lieu-et-infos|partenaires|a-propos|nous-joindre)\/*$/, function(cx, section) {
        myOnePager.hashHasChange(section);
        if (mySchedule.confIsOpen) {
          return mySchedule.closeConf();
        }
      });
      this.get(/\#\/horaire\/(.*)\/$/, function(cx, day) {
        if (myOnePager.windowInitialHash) {
          myOnePager.hashHasChange('horaire');
          myOnePager.windowInitialHash = null;
        }
        if (mySchedule.confIsOpen) {
          mySchedule.closeConf();
        }
        return mySchedule.slideTo(day);
      });
      return this.get(/\#\/horaire\/(.*)\/(.*)-([0-9]+)\/*\.html$/, function(cx, day, slug, id) {
        if (myOnePager.windowInitialHash) {
          myOnePager.hashHasChange('horaire');
          myOnePager.windowInitialHash = null;
        }
        mySchedule.slideTo(day);
        return mySchedule.showConf(id);
      });
    });
    router.debug = false;
    myOnePager.windowInitialHash = window.location.hash || null;
    router.run();
    myOnePager.animateWhenSliding = true;
    return stickyHeader = (function() {
      var header, headerOffsetTop, viewport;
      header = $('nav[role="navigation"]');
      headerOffsetTop = header.offset().top;
      viewport = $(window);
      return viewport.scroll(function() {
        if ((headerOffsetTop - viewport.scrollTop()) > 0) {
          return header.removeClass('sticky');
        } else {
          return header.addClass('sticky');
        }
      });
    })();
  });

}).call(this);
